<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vaccin Rage DZ — Calculateur officiel</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#0e3a5d" />
  <meta name="description" content="Calcul de la dose de sérum antirabique (eRIG/hRIG) et génération du calendrier vaccinal (Essen / Zagreb / Tissulaire) avec ajout à Google Calendar." />
  <style>
    :root {
      --bg: #f3f7fc;
      --fg: #102a43;
      --muted: #627d98;
      --brand: #0e3a5d;
      --ok: #2e7d32;
      --warn: #d84315;
      --card: #ffffff;
      --ring: rgba(14,58,93,.2);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; padding: 16px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--fg); background: var(--bg);
      -webkit-touch-callout: none; -webkit-user-select: none; user-select: none;
    }
    h1 { margin: 8px 0 12px; font-size: 1.5rem; }
    h2 { margin: 16px 0 8px; font-size: 1.2rem; }
    p { margin: 8px 0; color: var(--muted); }
    .app { max-width: 960px; margin: 0 auto; }
    .card {
      background: var(--card); border-radius: 14px; padding: 16px; margin: 12px 0;
      box-shadow: 0 8px 24px var(--ring), 0 1px 2px rgba(0,0,0,.06);
      border: 1px solid #e7eef5;
    }
    label { display: block; font-weight: 600; margin: 10px 0 6px; }
    input, select, button {
      width: 100%; font-size: 16px; padding: 12px 14px; border-radius: 10px;
      border: 1px solid #c7d2e3; outline: none; background: #fff;
    }
    input:focus, select:focus { box-shadow: 0 0 0 4px var(--ring); border-color: var(--brand); }
    .row { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 680px) { .row { grid-template-columns: repeat(2, 1fr); } }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn { cursor: pointer; background: var(--brand); color: #fff; font-weight: 700; border: none; }
    .btn.secondary { background: #455a64; }
    .btn.success { background: var(--ok); }
    .note { font-size: .9rem; color: var(--muted); }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #e2e8f0; padding: 10px; text-align: left; }
    thead th { background: #eef5fb; }
    .badge { display: inline-block; padding: 3px 8px; border-radius: 999px; font-size: .8rem; }
    .badge.warn { background: #ffe8e1; color: var(--warn); }
    .hidden { display: none; }
    .serum-box { background:#f8fafc; border-radius: 10px; padding: 10px; border:1px dashed #c7d2e3; }
    .footer { text-align:center; font-size:.85rem; color: var(--muted); margin-top: 16px; }
    .warning-note {
      background: #fff8e1;
      border-left: 4px solid #ffc107;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .emergency-info {
      background: #ffebee;
      border-left: 4px solid #f44336;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .precautions-info {
      background: #e8f5e8;
      border-left: 4px solid #4caf50;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .emergency-details, .precautions-details {
      background: #f5f5f5;
      padding: 12px;
      margin-top: 8px;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      font-size: 0.85rem;
    }
    .precautions-details ul {
      padding-left: 20px;
    }
    .precautions-details li {
      margin-bottom: 8px;
    }
    .special-note {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
<div class="app" role="application" aria-label="Calculateur de vaccination antirabique">
  <h1>Calculateur de Vaccination Antirabique</h1>
  <p class="note">Outil d'aide à la décision basé sur les schémas PEP (Essen / Zagreb) et l'ancien protocole tissulaire. Vérifiez toujours les recommandations locales.</p>

  <!-- SECTION: CALCUL SERUM -->
  <div class="card" aria-labelledby="serum-title">
    <h2 id="serum-title">Calcul de Sérum Antirabique (RIG)</h2>
    <div class="row">
      <div>
        <label for="rigType">Type d'immunoglobuline</label>
        <select id="rigType">
          <option value="erig" selected>eRIG — équine (40 IU/kg)</option>
          <option value="hrig">hRIG — humaine (20 IU/kg)</option>
        </select>
      </div>
      <div>
        <label for="patientWeight">Poids du patient (kg)</label>
        <input type="number" id="patientWeight" min="1" step="0.1" inputmode="decimal" placeholder="ex. 62.5" />
      </div>
    </div>
    <div class="row">
      <div>
        <label for="rigConc">Concentration (IU/ml)</label>
        <input type="number" id="rigConc" min="50" step="1" value="200" />
        <p class="note">Exemples: eRIG 200 IU/ml; hRIG 150–300 IU/ml selon produit.</p>
      </div>
    </div>
    <div class="actions">
      <button class="btn" id="btnSerum">Calculer la dose</button>
      <button class="btn secondary" id="btnResetSerum" type="button">Réinitialiser</button>
    </div>
    <div id="serumResult" class="serum-box hidden" aria-live="polite"></div>
    <div id="serumNote" class="warning-note hidden">
      <strong>Note importante:</strong> Après ouverture du flacon, les immunoglobulines antirabiques (RIG) doivent être utilisées dans les 6 heures.
    </div>
    
    <div id="dosageNote" class="warning-note hidden">
      <strong>Note importante:</strong> La posologie des IGAR est de 40 UI/Kg de poids corporel et ne doit jamais dépasser 3000 UI, un surdosage est susceptible d'inhiber la production active d'anticorps voire entraîner des accidents graves.
    </div>
    
    <div class="emergency-info" onclick="toggleEmergencyDetails()">
      <strong>En cas de réaction anaphylactique (اضغط للإظهار)</strong>
      <div id="emergencyDetails" class="emergency-details hidden">
        <ol>
          <li>Coucher la personne sur le dos les jambes surélevées</li>
          <li>Rétablir la perméabilité des voies respiratoires supérieures</li>
          <li>Oxygénation</li>
          <li>Administrer sans tarder 0.01 mg/kg d'adrénaline par voie IM</li>
          <li>Répéter au besoin à un autre site d'injection toutes les 5 à 15 min sans dépasser 0.5 ml</li>
          <li>Surveillance des signes vitaux (TA, pouls et respiration)</li>
          <li>Transférer le malade au service d'urgence</li>
        </ol>
      </div>
    </div>

    <div class="precautions-info" onclick="togglePrecautionsDetails()">
      <strong>Précautions et Considérations (IGAR) (اضغط للإظهار)</strong>
      <div id="precautionsDetails" class="precautions-details hidden">
        <ul>
          <li><strong>Le test de tolérance n'est plus recommandé</strong></li>
          <li>Les IGAR doivent être administrés une seule fois le même jour que la première dose de vaccin antirabique</li>
          <li>Si la dose d'IGAR à injecter s'avère insuffisante pour infiltrer toutes les plaies, le produit sera dilué avec du sérum physiologique à 0.9% pour obtenir la quantité nécessaire, jusqu'à dilution de 3 fois le volume initial</li>
          <li>Les IGAR ne doivent pas être administrées dans la même seringue que le vaccin antirabique</li>
          <li>Avant d'injecter le produit il faut tirer légèrement le piston de la seringue en arrière pour être certain que l'aiguille ne se trouve pas dans un vaisseau sanguin</li>
          <li>La majorité voire la totalité de la dose d'IGAR doit être infiltrée en profondeur et autour de la plaie en évitant un syndrome des loges</li>
          <li>L'injection de la dose restante d'IGAR par voie IM est indiquée en dépit d'un bénéfice limité. Privilégier l'infiltration en cas de stock limité</li>
          <li>Une plaie surinfectée après morsure ne constitue pas une contre-indication à une infiltration d'IGAR</li>
          <li>Pour les morsures et griffures devenues invisibles ou indétectables, les IGAR sont injectées autour du site d'exposition</li>
          <li>Dans le cas d'une exposition des muqueuses, rincer avec les IGAR diluées, infiltrer autour de la muqueuse et injecter le reste de la dose en IM</li>
          <li>Il n'est pas recommandé d'administrer les IGAR pour les personnes immunocompétentes ayants reçus une vaccination documentée en pré ou post-exposition par un vaccin cellulaire (2 doses ou plus) même plusieurs années après une première vaccination. L'administration des IGAR dans cette situation peut être un facteur inhibant la montée rapide des anticorps antirabiques secondaires au rappel vaccinal</li>
          <li>Il faut s'assurer de la disponibilité de l'adrénaline et des corticoïdes nécessaires pour le traitement d'une éventuelle réaction anaphylactique</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- SECTION: CALENDRIER VACCINAL -->
  <div class="card" aria-labelledby="cal-title">
    <h2 id="cal-title">Calendrier Vaccinal</h2>
    <div class="row">
      <div>
        <label for="vaccineType">Type de vaccin</label>
        <select id="vaccineType" onchange="showProtocolOptions()">
          <option value="">— Choisir —</option>
          <option value="cellulaire">Vaccin cellulaire (IM)</option>
          <option value="tissulaire">Vaccin tissulaire (SC)</option>
          <option value="intradermique">Vaccin intradermique (ID) - Patients à risque hémorragique</option>
        </select>
      </div>
      <div id="protocolWrap" class="hidden">
        <label for="protocol">Protocole</label>
        <select id="protocol">
          <option value="">— Choisir —</option>
          <option value="essen">Essen — J0,3,7,14,28 (IM)</option>
          <option value="zagreb">Zagreb — 2×J0, J7, J21 (IM)</option>
        </select>
      </div>
    </div>

    <div id="gradeWrap" class="hidden">
      <label for="exposureGrade">Grade / Catégorie d'exposition</label>
      <select id="exposureGrade">
        <option value="">— Choisir —</option>
        <option value="grade2">Grade 2 (Cat. II)</option>
        <option value="grade3">Grade 3 (Cat. III) — RIG indiqué</option>
      </select>
    </div>

    <div id="intradermiqueWrap" class="hidden">
      <label for="intradermiqueProtocol">Protocole intradermique (ID)</label>
      <select id="intradermiqueProtocol">
        <option value="">— Choisir —</option>
        <option value="sans_antecedent">Sans antécédent de vaccination (6 doses)</option>
        <option value="avec_antecedent">Antécédent de vaccination (2 ou 4 doses)</option>
        <option value="pre_exposition">Prophylaxie pré-exposition (4 doses)</option>
      </select>
    </div>

    <div class="row">
      <div>
        <label for="startDate">Date de la 1ère dose (J0)</label>
        <input type="date" id="startDate" />
      </div>
    </div>

    <div id="intradermiqueNote" class="special-note hidden">
      <strong>NB:</strong> Pour le protocole intradermique, la dose est de 0.1 ml par site d'injection.
    </div>

    <div class="actions">
      <button class="btn" id="btnSchedule">Calculer le calendrier</button>
      <button class="btn secondary" id="btnResetSchedule" type="button">Effacer</button>
      <button class="btn success" id="btnPrint" type="button">Imprimer / PDF</button>
    </div>

    <div id="advice" class="note" aria-live="polite"></div>

    <table id="resultTable" class="hidden" aria-describedby="advice">
      <thead>
        <tr>
          <th scope="col">Jour</th>
          <th scope="col">Date</th>
          <th scope="col">Détails</th>
          <th scope="col">Rappel</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="footer">« Vaccin Rage DZ » — outil éducatif, ne remplace pas le jugement clinique. ©2025</div>
</div>

<script>
// دالة لعرض/إخفاء تفاصيل الطوارئ
function toggleEmergencyDetails() {
  const details = document.getElementById('emergencyDetails');
  details.classList.toggle('hidden');
}

// دالة لعرض/إخفاء تفاصيل الاحتياطات
function togglePrecautionsDetails() {
  const details = document.getElementById('precautionsDetails');
  details.classList.toggle('hidden');
}

// ---------- SERUM (RIG) ----------
function calcRIGDose() {
  const type = document.getElementById('rigType').value; // erig/hrig
  const weight = parseFloat(document.getElementById('patientWeight').value);
  const conc = parseFloat(document.getElementById('rigConc').value);

  if (!weight || weight <= 0) return { error: 'Veuillez entrer un poids valide.' };
  if (!conc || conc <= 0) return { error: 'Veuillez entrer une concentration valide (IU/ml).' };

  const iuPerKg = type === 'hrig' ? 20 : 40;
  const theoreticalIU = weight * iuPerKg;
  
  // تحديد الجرعة النهائية مع الحد الأقصى فقط (3000 UI) وبدون حد أدنى
  const finalIU = Math.min(3000, theoreticalIU);
  
  const volumeMl = finalIU / conc;
  
  return { 
    type, 
    weight, 
    conc, 
    theoreticalIU, 
    finalIU,
    volumeMl 
  };
}

function renderRIG() {
  const out = document.getElementById('serumResult');
  const note = document.getElementById('serumNote');
  const dosageNote = document.getElementById('dosageNote');
  const res = calcRIGDose();
  
  if (res.error) { 
    out.classList.remove('hidden'); 
    out.innerHTML = `<span class="badge warn">${res.error}</span>`; 
    note.classList.add('hidden');
    dosageNote.classList.add('hidden');
    return; 
  }
  
  const label = res.type === 'hrig' ? 'hRIG (humaine)' : 'eRIG (équine)';
  out.classList.remove('hidden');
  note.classList.remove('hidden');
  dosageNote.classList.remove('hidden');
  
  out.innerHTML = `
    <strong>Type:</strong> ${label}<br/>
    <strong>Dose théorique:</strong> ${res.theoreticalIU.toFixed(0)} UI<br/>
    <strong>Dose à administrer:</strong> ${res.finalIU.toFixed(0)} UI<br/>
    <strong>Volume à injecter:</strong> ${res.volumeMl.toFixed(2)} ml (à ${res.conc.toFixed(0)} IU/ml)
  `;
}

document.getElementById('btnSerum').addEventListener('click', renderRIG);

document.getElementById('btnResetSerum').addEventListener('click', () => {
  document.getElementById('patientWeight').value = '';
  document.getElementById('rigConc').value = '200';
  document.getElementById('rigType').value = 'erig';
  const out = document.getElementById('serumResult'); 
  out.classList.add('hidden'); 
  out.innerHTML='';
  document.getElementById('serumNote').classList.add('hidden');
  document.getElementById('dosageNote').classList.add('hidden');
  document.getElementById('emergencyDetails').classList.add('hidden');
  document.getElementById('precautionsDetails').classList.add('hidden');
});

// ---------- SCHEDULES ----------
const PROTOCOLS = {
  cellulaire: {
    essen: {
      name: 'Essen (IM)',
      schedule: [0,3,7,14,28].map(d => ({ day: d, detail: '1 injection IM (1 ml)' }))
    },
    zagreb: {
      name: 'Zagreb (IM)',
      schedule: [
        { day: 0, detail: '2 injections IM (2 sites x 1 ml)' },
        { day: 7, detail: '1 injection IM (1 ml)' },
        { day: 21, detail: '1 injection IM (1 ml)' }
      ]
    }
  },
  tissulaire: {
    grade2: {
      name: 'Protocole tissulaire — Grade 2',
      schedule: [0,1,2,3,4,5,6].map(d => ({ day: d, detail: 'SC péri-ombilical (>5 ans: 2 ml / ≤5 ans: 1 ml)' }))
        .concat([
          { day: 10, detail: 'SC (>5 ans: 0,25 ml / ≤5 ans: 0,1 ml)' },
          { day: 14, detail: 'SC (>5 ans: 0,25 ml / ≤5 ans: 0,1 ml)' },
          { day: 29, detail: 'SC (>5 ans: 0,25 ml / ≤5 ans: 0,1 ml)' },
          { day: 90, detail: 'SC (>5 ans: 0,25 ml / ≤5 ans: 0,1 ml)' }
        ])
    },
    grade3: {
      name: 'Protocole tissulaire — Grade 3 (+ RIG)',
      schedule: [0,1,2,3,4,5,6].map(d => ({ day: d, detail: 'SC péri-ombilical (>5 ans: 2 ml / ≤5 ans: 1 ml)' }))
        .concat([
          { day: 10, detail: 'SC (>5 ans: 0,25 ml / ≤5 ans: 0,1 ml)' },
          { day: 14, detail: 'SC (>5 ans: 0,25 ml / ≤5 ans: 0,1 ml)' },
          { day: 24, detail: 'SC (>5 ans: 0,25 ml / ≤5 ans: 0,1 ml)' },
          { day: 34, detail: 'SC (>5 ans: 0,25 ml / ≤5 ans: 0,1 ml)' },
          { day: 90, detail: 'SC (>5 ans: 0,25 ml / ≤5 ans: 0,1 ml)' }
        ])
    }
  },
  intradermique: {
    sans_antecedent: {
      name: 'Intradermique - Sans antécédent de vaccination',
      schedule: [
        { day: 0, detail: '2 injections ID (2 sites x 0.1 ml) + IGAR' },
        { day: 3, detail: '2 injections ID (2 sites x 0.1 ml)' },
        { day: 7, detail: '2 injections ID (2 sites x 0.1 ml)' }
      ]
    },
    avec_antecedent: {
      name: 'Intradermique - Avec antécédent de vaccination',
      schedule: [
        { day: 0, detail: '1 injection ID (1 site x 0.1 ml)' },
        { day: 3, detail: '1 injection ID (1 site x 0.1 ml)' }
      ]
    },
    pre_exposition: {
      name: 'Intradermique - Prophylaxie pré-exposition',
      schedule: [
        { day: 0, detail: '2 injections ID (2 sites x 0.1 ml)' },
        { day: 7, detail: '2 injections ID (2 sites x 0.1 ml)' }
      ]
    }
  }
};

// عرض خيارات البروتوكول بناءً على نوع اللقاح
function showProtocolOptions() {
  const type = document.getElementById('vaccineType').value;
  const wrapProt = document.getElementById('protocolWrap');
  const wrapGrade = document.getElementById('gradeWrap');
  const wrapIntradermique = document.getElementById('intradermiqueWrap');
  const intradermiqueNote = document.getElementById('intradermiqueNote');
  const protSel = document.getElementById('protocol');
  const gradeSel = document.getElementById('exposureGrade');
  const intradermiqueSel = document.getElementById('intradermiqueProtocol');

  protSel.value = '';
  gradeSel.value = '';
  intradermiqueSel.value = '';
  wrapProt.classList.add('hidden');
  wrapGrade.classList.add('hidden');
  wrapIntradermique.classList.add('hidden');
  intradermiqueNote.classList.add('hidden');

  if (type === 'cellulaire') {
    wrapProt.classList.remove('hidden');
  } else if (type === 'tissulaire') {
    wrapGrade.classList.remove('hidden');
  } else if (type === 'intradermique') {
    wrapIntradermique.classList.remove('hidden');
    intradermiqueNote.classList.remove('hidden');
  }
}

document.getElementById('vaccineType').addEventListener('change', showProtocolOptions);

function addDays(date, days) { 
  const d = new Date(date); 
  d.setDate(d.getDate()+days); 
  return d; 
}

function toGCalDate(date) {
  const d0 = new Date(date); 
  const d1 = addDays(date, 1);
  const fmt = (d) => d.toISOString().slice(0,10).replace(/-/g,'');
  return `${fmt(d0)}/${fmt(d1)}`;
}

// دالة لتنسيق التاريخ بالتنسيق j/m/aaaa
function formatDate(date) {
  const day = date.getDate();
  const month = date.getMonth() + 1;
  const year = date.getFullYear();
  return `${day}/${month}/${year}`;
}

function buildSchedule() {
  const type = document.getElementById('vaccineType').value;
  const prot = document.getElementById('protocol').value;
  const grade = document.getElementById('exposureGrade').value;
  const intradermiqueProt = document.getElementById('intradermiqueProtocol').value;
  const start = document.getElementById('startDate').value;

  if (!type) return alert("Veuillez sélectionner le type de vaccin.");
  if (!start) return alert("Veuillez renseigner la date de J0.");
  
  if (type === 'cellulaire' && !prot) return alert("Veuillez choisir un protocole IM.");
  if (type === 'tissulaire' && !grade) return alert("Veuillez choisir le grade.");
  if (type === 'intradermique' && !intradermiqueProt) return alert("Veuillez choisir le protocole intradermique.");

  const base = new Date(start);
  let cfg;
  
  if (type === 'cellulaire') {
    cfg = PROTOCOLS.cellulaire[prot];
  } else if (type === 'tissulaire') {
    cfg = PROTOCOLS.tissulaire[grade];
  } else if (type === 'intradermique') {
    cfg = PROTOCOLS.intradermique[intradermiqueProt];
  }

  const advice = document.getElementById('advice');
  const tbody = document.querySelector('#resultTable tbody');
  const table = document.getElementById('resultTable');
  
  tbody.innerHTML = '';
  table.classList.remove('hidden');
  
  if (type === 'tissulaire' && grade === 'grade3') {
    advice.innerHTML = '<strong>Note:</strong> Pour une exposition de Grade III, l\'administration de sérum antirabique est obligatoire.';
  } else if (type === 'intradermique' && intradermiqueProt === 'sans_antecedent') {
    advice.innerHTML = '<strong>Note:</strong> Pour les patients sans antécédent de vaccination, l\'administration d\'IGAR est nécessaire.';
  } else {
    advice.innerHTML = '';
  }

  cfg.schedule.forEach(item => {
    const date = addDays(base, item.day);
    const dateStr = formatDate(date); // استخدام التنسيق الجديد j/m/aaaa
    
    const gcalDate = toGCalDate(date);
    const title = `Vaccin Rage J${item.day}`;
    const details = item.detail;
    const href = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${gcalDate}&details=${encodeURIComponent(details)}`;
    
    tbody.innerHTML += `
      <tr>
        <td>J${item.day}</td>
        <td>${dateStr}</td>
        <td>${item.detail}</td>
        <td><a href="${href}" target="_blank"><button class="btn secondary" style="padding: 6px 12px; font-size: 14px;">+ Calendrier</button></a></td>
      </tr>
    `;
  });
}

document.getElementById('btnSchedule').addEventListener('click', buildSchedule);

document.getElementById('btnResetSchedule').addEventListener('click', () => {
  document.getElementById('vaccineType').value = '';
  document.getElementById('protocol').value = '';
  document.getElementById('exposureGrade').value = '';
  document.getElementById('intradermiqueProtocol').value = '';
  document.getElementById('startDate').value = '';
  document.getElementById('protocolWrap').classList.add('hidden');
  document.getElementById('gradeWrap').classList.add('hidden');
  document.getElementById('intradermiqueWrap').classList.add('hidden');
  document.getElementById('intradermiqueNote').classList.add('hidden');
  document.getElementById('resultTable').classList.add('hidden');
  document.getElementById('advice').innerHTML = '';
});

// تهيئة التاريخ الحالي
document.getElementById('startDate').valueAsDate = new Date();

// إضافة event listener للزر print (وظيفة أساسية)
document.getElementById('btnPrint').addEventListener('click', () => {
  window.print();
});
</script>
</body>
</html>
